import React, { useState, useEffect } from "react";
import { v4 as uuidv4 } from "uuid"; // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID
import GoalForm from "../components/GoalForm"; // –ò–º–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Ñ–æ—Ä–º—ã —Ü–µ–ª–∏
import styles from "./GoalsPage.module.css"; // –ò–º–ø–æ—Ä—Ç —Å—Ç–∏–ª–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
import { api } from "../api/api.js"; // –ò–º–ø–æ—Ä—Ç API-–º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ü–µ–ª—è–º–∏

const GoalsPage = () => {
  const userId = "demo-user-id"; // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ –±—É–¥—É—â–µ–º –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π)

  const [goals, setGoals] = useState([]); // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ü–µ–ª–µ–π

  // =========================
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π —Å backend –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  // =========================
  useEffect(() => {
    const loadGoals = async () => {
      try {
        const data = await api.getGoals(userId); // –ó–∞–ø—Ä–æ—Å —Ü–µ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (data.length > 0) {
          // –ï—Å–ª–∏ —Ü–µ–ª–∏ –µ—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∑–∞–¥–∞—á
          setGoals(data.map(g => ({
            ...g, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è —Ü–µ–ª–∏
            tasks: g.tasks || [{ id: uuidv4(), text: "" }], // –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –æ–¥–Ω—É –ø—É—Å—Ç—É—é
            adding: false, // –§–ª–∞–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è)
          })));
        } else {
          // –ï—Å–ª–∏ —Ü–µ–ª–µ–π –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º –¥–≤–µ –ø—É—Å—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          setGoals([
            {
              id: uuidv4(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ü–µ–ª–∏
              name: "–¶–µ–ª—å 1", // –ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏
              deadline: "", // –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–π)
              results: "", // –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø–æ–∫–∞ –ø—É—Å—Ç—ã–µ)
              tasks: [{ id: uuidv4(), text: "" }], // –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á (–æ–¥–Ω–∞ –ø—É—Å—Ç–∞—è –∑–∞–¥–∞—á–∞)
              adding: false, // –§–ª–∞–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è)
            },
            {
              id: uuidv4(),
              name: "–¶–µ–ª—å 2",
              deadline: "",
              results: "",
              tasks: [{ id: uuidv4(), text: "" }],
              adding: false,
            },
          ]);
        }
      } catch (error) {
        console.error(error); // –õ–æ–≥–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ü–µ–ª–µ–π
      }
    };
    loadGoals(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–ª–µ–π
  }, []); // –≠—Ñ—Ñ–µ–∫—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)

  // =========================
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ü–µ–ª–∏
  // =========================
  const addGoal = () => {
    if (goals.length >= 5) {
      alert("–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Ü–µ–ª–µ–π"); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–µ–ª–µ–π
      return;
    }

    const newGoal = {
      id: uuidv4(), // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –Ω–æ–≤–æ–π —Ü–µ–ª–∏
      name: `–¶–µ–ª—å ${goals.length + 1}`, // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–¶–µ–ª—å 3¬ª)
      deadline: "", // –ü—É—Å—Ç–æ–π —Å—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
      results: "", // –ü—É—Å—Ç—ã–µ –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      tasks: [{ id: uuidv4(), text: "", adding: true }], // –û–¥–Ω–∞ –ø—É—Å—Ç–∞—è –∑–∞–¥–∞—á–∞ —Å —Ñ–ª–∞–≥–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
      adding: true, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    };

    setGoals([...goals, newGoal]); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ü–µ–ª—å –≤ —Å–ø–∏—Å–æ–∫

    // –ß–µ—Ä–µ–∑ 10 –º—Å —Å–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    setTimeout(() => {
      setGoals(prev => prev.map(g =>
        g.id === newGoal.id ? { ...g, adding: false } : g
      ));
    }, 10);
  };

  // =========================
  // –£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
  // =========================
  const removeGoal = (goalId) => {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ (–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å —ç–ª–µ–º–µ–Ω—Ç–∞)
    setGoals(prev => prev.map(g =>
      g.id === goalId ? { ...g, removing: true } : g
    ));

    // –ß–µ—Ä–µ–∑ 300 –º—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º —Ü–µ–ª—å –∏–∑ —Å–ø–∏—Å–∫–∞
    setTimeout(() => {
      setGoals(prev => prev.filter(g => g.id !== goalId));
    }, 300);
  };

  // =========================
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–ª–µ–π –Ω–∞ backend
  // =========================
  const saveGoals = async () => {
    try {
      await api.saveGoals(userId, goals); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      alert("–¶–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!"); // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    } catch (error) {
      console.error(error); // –õ–æ–≥–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ü–µ–ª–µ–π"); // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    }
  };

  return (
    <div className={styles.container}>
      <h1>–¶–µ–ª–∏</h1>
      <p className={styles.note}>–ú–æ–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –¥–æ 5 —Ü–µ–ª–µ–π</p>

      {/* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏ */}
      {goals.map(goal => (
        <GoalForm
          key={goal.id} // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–ø–∏—Å–∫–∞
          goal={goal} // –ü–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏
          setGoals={setGoals} // –ü–µ—Ä–µ–¥–∞—ë–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ü–µ–ª–µ–π
          removeGoal={removeGoal} // –ü–µ—Ä–µ–¥–∞—ë–º —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è —Ü–µ–ª–∏
        />
      ))}

      <div className={styles.buttons}>
        {/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ü–µ–ª–∏ */}
        <button onClick={addGoal} className={styles.addGoalBtn}>
          + –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å
        </button>
        {/* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ü–µ–ª–µ–π */}
        <button onClick={saveGoals} className={styles.saveGoalBtn}>
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª–∏
        </button>
      </div>
    </div>
  );
};

export default GoalsPage; // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö
